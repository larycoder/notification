<!DOCTYPE html>

<head>
    <title>Detail Note</title>
    <link href="css/detailNote.css" rel="stylesheet">
    <script src="js/api.js"></script>
    <script src="js/data.js"></script>
    <script src="js/render.js"></script>
    <script>
        var params;
        var fields;
        var objUrl;
        function getObject() {
            let url = window.location.href;
            params = convertUrlParamToJson(url);

            url = "/noteApi/";
            url += params["type"] + "/" + params["id"];
            objUrl = url;

            let data = callSimpleApi("GET", url);
            return getObjectFromResponse(data, 0);
        }

        function renderInfo() {
            let obj = getObject();
            let notes = document.getElementById("notes_data");
            let extra = document.getElementById("extra_info");

            // task render
            if(params.type == "diary") {
                document.getElementById("task_title").innerHTML = "Activity: ";
                document.getElementById("task_data").value = obj.activity;
                delete obj.activity;
            } else {
                document.getElementById("task_title").innerHTML = "Task: ";
                document.getElementById("task_data").value = obj.task;
                delete obj.task;
            }

            // notes render
            notes.innerHTML = obj.notes;
            delete obj.notes;

            // extra info render
            fields = Object.keys(obj);
            for(let key of Object.keys(obj)) {
                let id = "extra_info_value_" + key;
                let value = "";
                if(obj[key] === null) {
                    value = "";
                } else {
                    value = `value = "${obj[key]}"`;
                }
                obj[key] = `<input type="text" id="${id}" ${value}>`;
            }

            let dataAsArray = convertObjToArray(["key", "value"], obj);
            let dataAsRespObj = {
                "count": dataAsArray.length,
                "data": dataAsArray
            }
            extra.innerHTML = renderJsonAsTable(dataAsRespObj, "extra_info");

            modifyDOMProperties();
        }

        function saveNote() {
            let payload = {};
            let saveOpt = document.getElementById("save_opt").value;

            // task
            if(params.type == "diary") {
                payload.activity = document.getElementById("task_data").value;
            } else {
                payload.task = document.getElementById("task_data").value;
            }

            // notes
            payload.notes = document.getElementById("notes_data").value;

            // extra fields
            for(let field of fields) {
                let data = document.getElementById("extra_info_value_" + field).value;
                if(data || saveOpt == "all") {
                    if(! data) data = null;
                    payload[field] = data;
                }
            }

            // submit payload
            let resp = callSimpleApi("PUT", objUrl, JSON.stringify(payload));
            console.log(resp);
            renderDebugText(resp, "debug_log_box", 1000);
        }
    </script>
    <script>
        // script to modify DOM properties
        var keyPressArray = [];
        function modifyDOMProperties() {
            document.getElementById('notes_data').addEventListener('keydown', function(e) {
                // allow tab in textarea of notes
                if (e.key == 'Tab') {
                    e.preventDefault();
                    let start = this.selectionStart;
                    let end = this.selectionEnd;
                    this.value = this.value.substring(0, start + 1) +
                        "    " + this.value.substring(end + 1);

                    // put caret at right position again
                    this.selectionStart = this.selectionEnd = start + 4;

                // allow save by Crtl + s
                } else if (e.key == 's' && keyPressArray.indexOf("Control") > -1) {
                    e.preventDefault();
                    saveNote();
                }

                // track key press
                if(keyPressArray.indexOf(e.key) == -1) {
                    keyPressArray.push(e.key);
                }
            });
            document.getElementById('notes_data').addEventListener('keyup', function(e) {
                let kIdx = keyPressArray.indexOf(e.key);
                if(kIdx > -1) {
                    keyPressArray.splice(kIdx, 1);
                }
            });
        }
    </script>
</head>

<body>
<div>
    <p id="debug_log_box" style="background-color: #EFA9A9"></p>
</div>
<div>
    <h2>Note Detail</h2>
    <button style="margin-bottom: 20px" type="button" onclick="saveNote()">Save</button>
    <select id="save_opt">
        <option value="value" selected>value</option>
        <option value="all">all</option>
    </select>
</div>
<div>
    <div style="float:left">
        <div id="task">
            <label for="task_data" id="task_title"></label>
            <input style="width:58vw" id="task_data">
        </div>
        <div id="notes">
            <h4>Notes: </h4>
            <textarea id="notes_data" style="width: 60vw; height: 70vh;"></textarea>
        </div>
    </div>
    <div style="float:right" id="extra_info"></div>
</div>
<script>renderInfo();</script>
</body>