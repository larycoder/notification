<!DOCTYPE html>

<head>
    <title>List Note</title>
    <script src="js/api.js"></script>
    <script src="js/data.js"></script>
    <script src="js/render.js"></script>
    <script>
        // table information script
        function createInfoTable() {
            let opt = document.getElementById("log_opt_type").value;
            let data = callSimpleApi("GET", "/noteApi/" + opt);
            data = convertTextToJson(data);
            document.getElementById("info").innerHTML = renderJsonAsTable(data, "info");
        }

        function addDetailNotePageToTable() {
            let table = document.getElementById("info_table");
            let idValues = getColumnValuesOfTable(table, "id");
            let opt = document.getElementById("log_opt_type").value;

            let linkValues = [];
            for(id of idValues) {
                let link = "detailNote.html?id=" + id + "&type=" + opt;
                let tag = "<a href = \"" + link + "\">ref</a>";
                linkValues.push(tag);
            }
            addColToTable(table, "detail", linkValues);
        }

        function showInfoTable() {
            createInfoTable();
            addDetailNotePageToTable();
        }
    </script>
    <script>
        // new note dialog script
        function renderInputTag(field, posId) {
            text = ""
            if(field == "notes") {
                text += `<textarea id="${posId}_${field}">`;
                text += `</textarea>`;
            } else if(field == "parentId") {
                text += `<input `;
                let type = "number";
                text += `id = "${posId}_${field}" type="${type}" name="${field}"`;
                text += `>`;
            } else {
                text += `<input `;
                let type = "text";
                text += `id = "${posId}_${field}" type="${type}" name="${field}"`;
                text += `>`;
            }
            return text;
        }

        function getFieldsByType(type) {
            if(type == "task") {
                return [
                    "task", "parentId", "notes", "label",
                    "priority", "deadline", "measurement", "process"
                ];
            } else {
                return [
                    "activity", "notes", "start_time", "duration", "taskId"
                ]
            }
        }

        function createBox() {
            let opt = document.getElementById("log_opt_type").value;
            let fields = getFieldsByType(opt);

            let box = document.getElementById("new_note_box");
            let boxBorder = document.getElementById("new_note");
            let boxData = renderInputBox(fields, renderInputTag, "new_note_box");
            box.innerHTML = boxData;
            boxBorder.style.display = "block";

            modifyDOMProperties();
        }

        function cancelBox() {
            document.getElementById("new_note_box").innerHTML = "";
            document.getElementById("new_note").style.display = "none";
        }

        function addNewNote() {
            let opt = document.getElementById("log_opt_type").value;
            let fields = getFieldsByType(opt);

            let payload = {};
            for(field of fields) {
                let holder = document.getElementById("new_note_box_" + field);
                let value = getValueFromHolder(holder);
                if(value) payload[field] = value;
            }

            let url = "/noteApi/" + opt;
            let payloadString = JSON.stringify(payload);
            console.log(callSimpleApi("POST", url, payloadString));
        }
    </script>
    <script>
        // modify default properties of DOM

        function modifyDOMProperties() {
            // allow tab in textarea of notes
            document.getElementById('new_note_box_notes').addEventListener('keydown', function(e) {
                if (e.key == 'Tab') {
                e.preventDefault();
                var start = this.selectionStart;
                var end = this.selectionEnd;

                // set textarea value to: text before caret + tab + text after caret
                this.value = this.value.substring(0, start) +
                  "    " + this.value.substring(end);

                // put caret at right position again
                this.selectionStart =
                  this.selectionEnd = start + 1;
              }
            });
        }
    </script>
</head>

<body>
    <h2>Dashboard</h2>
    <div id="log_opt">
        <label for="log_opt_type">Log Type:</label>
        <select id="log_opt_type">
            <option value="task" selected>task</option>
            <option value="diary">diary</option>
        </select>
        <button type="button" onclick="showInfoTable()">Submit</button>
        <button type="button" onclick="createBox()">New</button>
    </div>
    <div style="display:none" id="new_note">
        <div id="new_note_box"></div>
        <div id="new_note_button">
            <button type="button" onclick="addNewNote()">Add</button>
            <button type="button" onclick="cancelBox()">Cancel</button>
        </div>
    </div>
    <div id="info"></div>
</body>